name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            name: 'mac-arm64'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            name: 'mac-x64'
          - platform: 'windows-latest'
            args: ''
            name: 'windows-x64'

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        working-directory: cloud-downloader
        run: npm install

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: cloud-downloader
          tagName: ${{ github.ref_name }}
          releaseName: 'æ¸…åäº‘ç›˜ä¸‹è½½å™¨ ${{ github.ref_name }}'
          releaseBody: |
            # æ¸…åäº‘ç›˜ä¸‹è½½å™¨ v1.0.0

            é¦–ä¸ªæ­£å¼ç‰ˆæœ¬å‘å¸ƒï¼

            ## åŠŸèƒ½
            - ğŸ“¥ **æ‰¹é‡ä¸‹è½½**ï¼šä¸€é”®ä¸‹è½½åˆ†äº«é“¾æ¥ä¸­çš„æ‰€æœ‰æ–‡ä»¶
            - ğŸ“ **é€‰æ‹©æ€§ä¸‹è½½**ï¼šè‡ªç”±å‹¾é€‰éœ€è¦çš„æ–‡ä»¶/æ–‡ä»¶å¤¹
            - ğŸ“¦ **å¤§æ–‡ä»¶æ”¯æŒ**ï¼šæµå¼ä¼ è¾“ï¼Œæ”¯æŒ GB çº§æ–‡ä»¶ä¸‹è½½
            - ğŸ” **å¯†ç ä¿æŠ¤**ï¼šæ”¯æŒå¸¦å¯†ç çš„åˆ†äº«é“¾æ¥
            - ğŸ“Š **å®æ—¶è¿›åº¦**ï¼šå•æ–‡ä»¶ + æ€»ä½“è¿›åº¦å®æ—¶æ˜¾ç¤º

            ## ä¸‹è½½è¯´æ˜
            - **Mac (Apple Silicon)**: ä¸‹è½½ `aarch64.dmg` æ–‡ä»¶
            - **Mac (Intel)**: ä¸‹è½½ `x64.dmg` æ–‡ä»¶
            - **Windows**: ä¸‹è½½ `.msi` æˆ– `.exe` å®‰è£…åŒ…

            ## å®‰è£…æ³¨æ„
            ### Mac
            é¦–æ¬¡æ‰“å¼€å¦‚æç¤º"å·²æŸåï¼Œæ— æ³•æ‰“å¼€"ï¼Œè¯·åœ¨ç»ˆç«¯æ‰§è¡Œï¼š
            ```bash
            xattr -cr /Applications/TsinghuaCloudDownloader.app
            ```
            ### Windows
            å¯èƒ½è§¦å‘ SmartScreenï¼Œç‚¹å‡»ã€Œä»è¦è¿è¡Œã€å³å¯
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}
